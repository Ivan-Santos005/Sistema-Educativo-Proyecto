<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generar Datos de Ejemplo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    h1 {
      color: #6B8E6B;
      text-align: center;
      margin-bottom: 30px;
    }
    .btn {
      background: #6B8E6B;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
      display: block;
      width: 100%;
    }
    .btn:hover {
      background: #5a7a5a;
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    .success {
      background: #e8f5e8;
      color: #2e7d32;
    }
    .error {
      background: #ffebee;
      color: #c62828;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
    }
    .progress {
      background: #e3f2fd;
      color: #1565c0;
    }
    .info {
      background: #f0f8f0;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      border-left: 4px solid #6B8E6B;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéì Generar Datos de Ejemplo</h1>
    
    <div class="info">
      <strong>üìã Este script crear√°:</strong>
      <ul>
        <li>3 materias de ejemplo (F√≠sica I, Matem√°ticas I, Simulaci√≥n 3D)</li>
        <li>3 usuarios: 1 docente y 2 alumnos</li>
        <li>Asignaciones docente-materia</li>
        <li>Inscripciones de alumnos</li>
        <li>Algunas calificaciones de ejemplo</li>
      </ul>
      <br>
      <strong>‚ö†Ô∏è Importante:</strong> Aseg√∫rate de que tu Firebase est√© configurado correctamente.
    </div>

    <div class="status" id="status"></div>
    
    <button class="btn" id="generateBtn" onclick="generateExampleData()">
      üöÄ Generar Datos de Ejemplo
    </button>
    
    <button class="btn" onclick="clearAllData()" style="background: #f44336;">
      üóëÔ∏è Limpiar Todos los Datos (Cuidado!)
    </button>

    <div id="progress" style="margin-top: 20px;"></div>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase-config.js';
    import { createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { 
      doc, 
      setDoc, 
      addDoc, 
      collection, 
      getDocs,
      deleteDoc 
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const statusDiv = document.getElementById('status');
    const progressDiv = document.getElementById('progress');
    const generateBtn = document.getElementById('generateBtn');

    function showStatus(message, type = 'progress') {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function addProgress(message) {
      const p = document.createElement('p');
      p.textContent = `‚úì ${message}`;
      p.style.color = '#2e7d32';
      p.style.margin = '5px 0';
      progressDiv.appendChild(p);
    }

    window.generateExampleData = async function() {
      generateBtn.disabled = true;
      progressDiv.innerHTML = '';
      
      try {
        showStatus('Iniciando generaci√≥n de datos de ejemplo...', 'progress');

        // 1. Crear materias
        showStatus('Creando materias...', 'progress');
        const materias = await createMaterias();
        addProgress('Materias creadas');

        // 2. Crear usuarios
        showStatus('Creando usuarios...', 'progress');
        const usuarios = await createUsuarios();
        addProgress('Usuarios creados');

        // 3. Crear asignaciones
        showStatus('Creando asignaciones docente-materia...', 'progress');
        await createAsignaciones(usuarios.docente, materias);
        addProgress('Asignaciones creadas');

        // 4. Crear inscripciones
        showStatus('Creando inscripciones de alumnos...', 'progress');
        await createInscripciones(usuarios.alumnos, materias);
        addProgress('Inscripciones creadas');

        // 5. Crear calificaciones de ejemplo
        showStatus('Creando calificaciones de ejemplo...', 'progress');
        await createCalificacionesEjemplo(usuarios.alumnos, materias);
        addProgress('Calificaciones de ejemplo creadas');

        showStatus('‚úÖ ¬°Datos de ejemplo generados exitosamente!', 'success');
        addProgress('¬°Listo! Ya puedes probar el sistema');

        setTimeout(() => {
          if (confirm('¬øQuieres ir al login para probar el sistema?')) {
            window.location.href = 'login.html';
          }
        }, 2000);

      } catch (error) {
        console.error('Error generando datos:', error);
        showStatus(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        generateBtn.disabled = false;
      }
    };

    async function createMaterias() {
      const materias = [
        {
          id: 'materia_fisica1',
          codigo: 'FIS101',
          nombre: 'F√≠sica I',
          unidades: ['Mec√°nica', 'Cinem√°tica', 'Din√°mica', 'Energ√≠a'],
          creditos: 6,
          semestre: 1
        },
        {
          id: 'materia_matematicas1',
          codigo: 'MAT101', 
          nombre: 'Matem√°ticas I',
          unidades: ['√Ålgebra', 'Geometr√≠a', 'Trigonometr√≠a', 'Funciones'],
          creditos: 5,
          semestre: 1
        },
        {
          id: 'materia_simulacion3d',
          codigo: 'SIM3D',
          nombre: 'Simulaci√≥n 3D',
          unidades: ['Modelado 3D', 'Animaci√≥n', 'Renderizado', 'Realidad Virtual'],
          creditos: 8,
          semestre: 8
        }
      ];

      const materiasCreadas = {};
      
      for (const materia of materias) {
        const { id, ...materiaData } = materia;
        await setDoc(doc(db, 'materias', id), {
          ...materiaData,
          createdAt: new Date().toISOString()
        });
        materiasCreadas[id] = materia;
      }

      return materiasCreadas;
    }

    async function createUsuarios() {
      const usuarios = {
        docente: null,
        alumnos: []
      };

      // Crear docente
      try {
        const docenteAuth = await createUserWithEmailAndPassword(auth, 'docente@universidad.edu', '123456');
        await setDoc(doc(db, 'users', docenteAuth.user.uid), {
          nombre: 'Dr. Juan P√©rez Garc√≠a',
          email: 'docente@universidad.edu',
          role: 'DOCENTE',
          numeroControl: 'DOC001',
          createdAt: new Date().toISOString(),
          status: 'active'
        });
        usuarios.docente = docenteAuth.user.uid;
        addProgress('Docente creado: docente@universidad.edu / 123456');
      } catch (error) {
        if (error.code === 'auth/email-already-in-use') {
          showStatus('El docente ya existe, usando existente...', 'warning');
          // Aqu√≠ podr√≠as obtener el UID del docente existente si lo necesitas
        } else {
          throw error;
        }
      }

      // Crear alumnos
      const alumnosData = [
        {
          email: 'alumno1@universidad.edu',
          password: '123456',
          nombre: 'Mar√≠a Gonz√°lez L√≥pez',
          numeroControl: '20250001'
        },
        {
          email: 'alumno2@universidad.edu', 
          password: '123456',
          nombre: 'Carlos Rodr√≠guez Mart√≠n',
          numeroControl: '20250002'
        }
      ];

      for (const alumnoData of alumnosData) {
        try {
          const alumnoAuth = await createUserWithEmailAndPassword(auth, alumnoData.email, alumnoData.password);
          await setDoc(doc(db, 'users', alumnoAuth.user.uid), {
            nombre: alumnoData.nombre,
            email: alumnoData.email,
            role: 'ALUMNO',
            numeroControl: alumnoData.numeroControl,
            createdAt: new Date().toISOString(),
            status: 'active'
          });
          usuarios.alumnos.push(alumnoAuth.user.uid);
          addProgress(`Alumno creado: ${alumnoData.email} / ${alumnoData.password}`);
        } catch (error) {
          if (error.code === 'auth/email-already-in-use') {
            addProgress(`Alumno ya existe: ${alumnoData.email}`);
          } else {
            throw error;
          }
        }
      }

      return usuarios;
    }

    async function createAsignaciones(docenteId, materias) {
      if (!docenteId) return;

      const asignaciones = [
        { materiaId: 'materia_fisica1', grupo: 'A1' },
        { materiaId: 'materia_matematicas1', grupo: 'B1' },
        { materiaId: 'materia_simulacion3d', grupo: 'C1' }
      ];

      for (const asignacion of asignaciones) {
        await addDoc(collection(db, 'asignaciones'), {
          docenteId: docenteId,
          materiaId: asignacion.materiaId,
          grupo: asignacion.grupo,
          periodo: '2025-1',
          createdAt: new Date().toISOString()
        });
      }
    }

    async function createInscripciones(alumnosIds, materias) {
      if (alumnosIds.length === 0) return;

      const materiaIds = Object.keys(materias);
      const grupos = ['A1', 'B1', 'C1'];

      for (let i = 0; i < alumnosIds.length; i++) {
        const alumnoId = alumnosIds[i];
        
        // Inscribir a cada alumno en 2-3 materias
        for (let j = 0; j < Math.min(materiaIds.length, 2 + i); j++) {
          await addDoc(collection(db, 'inscripciones'), {
            alumnoId: alumnoId,
            materiaId: materiaIds[j],
            grupo: grupos[j],
            periodo: '2025-1',
            status: 'activa',
            createdAt: new Date().toISOString()
          });
        }
      }
      
      addProgress(`Inscripciones creadas: ${materiaIds.length * Math.min(alumnosIds.length, 2)} inscripciones`);
    }

    async function createCalificacionesEjemplo(alumnosIds, materias) {
      if (alumnosIds.length === 0) return;

      const grupos = ['A1', 'B1', 'C1'];
      const materiaIds = Object.keys(materias);

      for (let i = 0; i < materiaIds.length; i++) {
        const materiaId = materiaIds[i];
        const materia = materias[materiaId];
        const grupo = grupos[i];
        const cursoId = `curso_${materia.codigo}_${grupo}`;

        const estudiantes = {};

        // Crear calificaciones para cada alumno inscrito
        for (const alumnoId of alumnosIds) {
          estudiantes[alumnoId] = {
            unidades: {},
            lastUpdated: new Date().toISOString()
          };

          // Crear calificaciones para cada unidad
          for (let unidadIndex = 0; unidadIndex < materia.unidades.length; unidadIndex++) {
            const unidadKey = `unidad_${unidadIndex}`;
            estudiantes[alumnoId].unidades[unidadKey] = {
              asistencia: Math.floor(Math.random() * 3) + 8, // 8-10
              responsabilidad: Math.floor(Math.random() * 3) + 7, // 7-9
              disposicion: Math.floor(Math.random() * 3) + 8, // 8-10
              conocimientos: Math.floor(Math.random() * 4) + 7 // 7-10
            };
          }
        }

        // Guardar calificaciones del curso
        await setDoc(doc(db, 'calificaciones', cursoId), {
          estudiantes: estudiantes,
          metadata: {
            docenteId: 'docente_ejemplo',
            materiaId: materiaId,
            materiaCodigo: materia.codigo,
            materiaNombre: materia.nombre,
            grupo: grupo,
            periodo: '2025-1',
            lastUpdated: new Date().toISOString()
          }
        });
      }
    }

    window.clearAllData = async function() {
      if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto eliminar√° TODOS los datos de ejemplo.')) {
        return;
      }

      if (!confirm('üö® √öLTIMA ADVERTENCIA: Se eliminar√°n materias, usuarios, asignaciones e inscripciones. ¬øContinuar?')) {
        return;
      }

      try {
        showStatus('Eliminando datos...', 'progress');
        progressDiv.innerHTML = '';

        // Eliminar colecciones
        const colecciones = ['materias', 'asignaciones', 'inscripciones', 'calificaciones'];
        
        for (const coleccion of colecciones) {
          const snapshot = await getDocs(collection(db, coleccion));
          for (const doc of snapshot.docs) {
            await deleteDoc(doc.ref);
          }
          addProgress(`Colecci√≥n ${coleccion} eliminada`);
        }

        showStatus('‚úÖ Datos eliminados exitosamente', 'success');
      } catch (error) {
        console.error('Error eliminando datos:', error);
        showStatus(`‚ùå Error: ${error.message}`, 'error');
      }
    };
  </script>
</body>
</html>