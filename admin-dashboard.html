<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n</title>
  <link rel="stylesheet" href="menu.css">
  <style>
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #f5f5dc 0%, #e8e8d8 100%);
      min-height: 100vh;
    }

    .header {
      background: #6B8E6B;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
    }

    .header-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .role-badge {
      background: rgba(255,255,255,0.2);
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
    }

    .poweruser { background: linear-gradient(45deg, #ff6b6b, #ffd93d); }
    .admin { background: linear-gradient(45deg, #4ecdc4, #44a08d); }

    .logout-btn {
      background: #5a7a5a;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .container {
  max-width: 1200px;
  margin: 20px auto;
  padding-top: 60px;   /* espacio debajo del header */
  padding-left: 20px;  /* padding izquierdo */
  padding-right: 20px; /* padding derecho */
}


    .tabs {
      display: flex;
      background: white;
      border-radius: 10px 10px 0 0;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }

    .tab {
      flex: 1;
      min-width: 150px;
      padding: 15px 20px;
      background: #f0f0f0;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.3s;
      text-align: center;
    }

    .tab.active {
      background: #6B8E6B;
      color: white;
    }

    .tab:hover:not(.active) {
      background: #e0e0e0;
    }

    .tab-content {
      background: white;
      padding: 30px;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 500px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .section-header h2 {
      color: #333;
      font-size: 22px;
    }

    .section-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .add-btn, .filter-btn {
      background: #6B8E6B;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .add-btn:hover, .filter-btn:hover {
      background: #5a7a5a;
    }

    .filter-btn {
      background: #17a2b8;
    }

    .search-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .filter-select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      min-width: 150px;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background: #f8f9fa;
      font-weight: bold;
      color: #333;
      position: sticky;
      top: 0;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .edit-btn, .delete-btn, .view-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }

    .edit-btn {
      background: #ffc107;
      color: #000;
    }

    .delete-btn {
      background: #dc3545;
      color: white;
    }

    .view-btn {
      background: #17a2b8;
      color: white;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background-color: white;
      margin: 3% auto;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .close {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #aaa;
    }

    .close:hover {
      color: #000;
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .form-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn-save, .btn-cancel {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-save {
      background: #6B8E6B;
      color: white;
    }

    .btn-cancel {
      background: #6c757d;
      color: white;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #6B8E6B;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .role-badge-table {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      color: white;
    }

    .role-poweruser { background: linear-gradient(45deg, #ff6b6b, #ffd93d); }
    .role-admin { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
    .role-docente { background: #6B8E6B; }
    .role-alumno { background: #17a2b8; }

    .permission-notice {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 9999;
      transition: all 0.3s ease;
      display: none;
    }

    .notification.success {
      background: #28a745;
    }

    .notification.error {
      background: #dc3545;
    }

    .notification.warning {
      background: #ffc107;
      color: #000;
    }

    @media (max-width: 768px) {
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        border-bottom: 1px solid #ddd;
      }
      
      .container {
        padding: 0 10px;
      }
      
      .modal-content {
        margin: 5% auto;
        width: 95%;
      }

      .section-header {
        flex-direction: column;
        align-items: stretch;
      }

      .search-container {
        flex-direction: column;
      }

      .form-row {
        flex-direction: column;
      }

      .form-group {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üõ†Ô∏è Panel de Administraci√≥n</h1>
    <div class="header-info">
      <span class="role-badge" id="userRoleBadge">ADMIN</span>
      <span id="userName">Cargando...</span>
      <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
      
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="showTab('usuarios')">üë• Usuarios</button>
      <button class="tab" onclick="showTab('materias')">üìö Materias</button>
      <button class="tab" onclick="showTab('asignaciones')">üë®‚Äçüè´ Asignaciones</button>
      <button class="tab" onclick="showTab('inscripciones')">üìù Inscripciones</button>
    </div>

    <div class="tab-content">
      <!-- Secci√≥n Usuarios -->
      <div class="section active" id="usuarios">
        <div class="section-header">
          <h2>Gesti√≥n de Usuarios</h2>
          <div class="section-actions">
            <button class="add-btn" onclick="openUserModal()">+ Agregar Usuario</button>
          </div>
        </div>

        <div class="permission-notice" id="permissionNotice" style="display: none;">
          <strong>‚ÑπÔ∏è Permisos limitados:</strong> <span id="permissionText"></span>
        </div>

        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-number" id="totalUsuarios">0</div>
            <div class="stat-label">Total Usuarios</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalDocentes">0</div>
            <div class="stat-label">Docentes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalAlumnos">0</div>
            <div class="stat-label">Alumnos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalAdmins">0</div>
            <div class="stat-label">Administradores</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalPowerUsers">0</div>
            <div class="stat-label">Power Users</div>
          </div>
        </div>

        <div class="search-container">
          <input type="text" class="search-input" placeholder="Buscar por nombre o email..." id="searchUsers">
          <select class="filter-select" id="filterUserRole">
            <option value="">Todos los roles</option>
            <option value="POWERUSER">Power Users</option>
            <option value="ADMIN">Administradores</option>
            <option value="DOCENTE">Docentes</option>
            <option value="ALUMNO">Alumnos</option>
          </select>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Email</th>
                <th>Rol</th>
                <th>No. Control</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="usersTable">
              <tr>
                <td colspan="6" class="loading">Cargando usuarios...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Secci√≥n Materias -->
      <div class="section" id="materias">
        <div class="section-header">
          <h2>Gesti√≥n de Materias</h2>
          <div class="section-actions">
            <button class="add-btn" onclick="openMateriaModal()">+ Agregar Materia</button>
          </div>
        </div>

        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-number" id="totalMaterias">0</div>
            <div class="stat-label">Total Materias</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalCreditos">0</div>
            <div class="stat-label">Total Cr√©ditos</div>
          </div>
        </div>

        <div class="search-container">
          <input type="text" class="search-input" placeholder="Buscar por nombre o c√≥digo..." id="searchMaterias">
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>Cr√©ditos</th>
                <th>Unidades</th>
                <th>Grupos</th>
                <th>Semestre</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="materiasTable">
              <tr>
                <td colspan="7" class="loading">Cargando materias...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Secci√≥n Asignaciones -->
      <div class="section" id="asignaciones">
        <div class="section-header">
          <h2>Asignaciones Docente-Materia</h2>
          <div class="section-actions">
            <button class="add-btn" onclick="openAsignacionModal()">+ Nueva Asignaci√≥n</button>
          </div>
        </div>

        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-number" id="totalAsignaciones">0</div>
            <div class="stat-label">Total Asignaciones</div>
          </div>
        </div>

        <div class="search-container">
          <input type="text" class="search-input" placeholder="Buscar por docente o materia..." id="searchAsignaciones">
          <select class="filter-select" id="filterPeriodo">
            <option value="">Todos los periodos</option>
            <option value="2025-1">2025-1</option>
            <option value="2024-2">2024-2</option>
          </select>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Docente</th>
                <th>Materia</th>
                <th>Grupo</th>
                <th>Periodo</th>
                <th>Fecha Creaci√≥n</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="asignacionesTable">
              <tr>
                <td colspan="6" class="loading">Cargando asignaciones...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Secci√≥n Inscripciones -->
      <div class="section" id="inscripciones">
        <div class="section-header">
          <h2>Inscripciones de Alumnos</h2>
          <div class="section-actions">
            <button class="add-btn" onclick="openInscripcionModal()">+ Nueva Inscripci√≥n</button>
            <button class="filter-btn" onclick="openMasiveInscripcionModal()">üìã Inscripci√≥n Masiva</button>
          </div>
        </div>

        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-number" id="totalInscripciones">0</div>
            <div class="stat-label">Total Inscripciones</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="inscripcionesActivas">0</div>
            <div class="stat-label">Activas</div>
          </div>
        </div>

        <div class="search-container">
          <input type="text" class="search-input" placeholder="Buscar por alumno o materia..." id="searchInscripciones">
          <select class="filter-select" id="filterGrupo">
            <option value="">Todos los grupos</option>
          </select>
          <select class="filter-select" id="filterMateria">
            <option value="">Todas las materias</option>
          </select>
          <select class="filter-select" id="filterEstadoInscripcion">
            <option value="">Todos los estados</option>
            <option value="activa">Activa</option>
            <option value="inactiva">Inactiva</option>
            <option value="completada">Completada</option>
          </select>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Alumno</th>
                <th>No. Control</th>
                <th>Materia</th>
                <th>Grupo</th>
                <th>Periodo</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="inscripcionesTable">
              <tr>
                <td colspan="8" class="loading">Cargando inscripciones...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Usuario -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('userModal')">&times;</span>
      <h3 id="userModalTitle">Agregar Usuario</h3>
      <form id="userForm">
        <div class="form-row">
          <div class="form-group">
            <label for="userName">Nombre Completo:</label>
            <input type="text" id="userNameInput" required>
          </div>
          <div class="form-group">
            <label for="userEmail">Email:</label>
            <input type="email" id="userEmail" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="userPassword">Contrase√±a:</label>
            <input type="password" id="userPassword" required>
          </div>
          <div class="form-group">
            <label for="userRole">Rol:</label>
            <select id="userRole" required>
              <option value="">Seleccionar rol</option>
              <!-- Las opciones se llenar√°n din√°micamente seg√∫n permisos -->
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="userControl">No. Control:</label>
            <input type="text" id="userControl" required>
          </div>
          <div class="form-group">
            <label for="userStatus">Estado:</label>
            <select id="userStatus">
              <option value="active">Activo</option>
              <option value="inactive">Inactivo</option>
            </select>
          </div>
        </div>
        <div class="form-buttons">
          <button type="button" class="btn-cancel" onclick="closeModal('userModal')">Cancelar</button>
          <button type="submit" class="btn-save">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Materia -->
  <div id="materiaModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('materiaModal')">&times;</span>
      <h3 id="materiaModalTitle">Agregar Materia</h3>
      <form id="materiaForm">
        <div class="form-row">
          <div class="form-group">
            <label for="materiaCodigo">C√≥digo:</label>
            <input type="text" id="materiaCodigo" required>
          </div>
          <div class="form-group">
            <label for="materiaNombre">Nombre:</label>
            <input type="text" id="materiaNombre" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="materiaCreditos">Cr√©ditos:</label>
            <input type="number" id="materiaCreditos" min="1" max="12" required>
          </div>
          <div class="form-group">
            <label for="materiaSemestre">Semestre:</label>
            <input type="number" id="materiaSemestre" min="1" max="12">
          </div>
        </div>
        <div class="form-group">
          <label for="materiaUnidades">Unidades (separadas por coma):</label>
          <input type="text" id="materiaUnidades" placeholder="Unidad 1, Unidad 2, Unidad 3" required>
        </div>
        <div class="form-group">
          <label for="materiaGrupos">Grupos (separados por coma):</label>
          <input type="text" id="materiaGrupos" placeholder="A, B, C" required>
        </div>
        <div class="form-buttons">
          <button type="button" class="btn-cancel" onclick="closeModal('materiaModal')">Cancelar</button>
          <button type="submit" class="btn-save">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Asignaci√≥n -->
  <div id="asignacionModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('asignacionModal')">&times;</span>
      <h3>Nueva Asignaci√≥n</h3>
      <form id="asignacionForm">
        <div class="form-row">
          <div class="form-group">
            <label for="asignacionDocente">Docente:</label>
            <select id="asignacionDocente" required>
              <option value="">Seleccionar docente</option>
            </select>
          </div>
          <div class="form-group">
            <label for="asignacionMateria">Materia:</label>
            <select id="asignacionMateria" required>
              <option value="">Seleccionar materia</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="asignacionGrupo">Grupo:</label>
            <select id="asignacionGrupo" required>
              <option value="">Seleccionar grupo</option>
            </select>
          </div>
          <div class="form-group">
            <label for="asignacionPeriodo">Periodo:</label>
            <select id="asignacionPeriodo" required>
              <option value="2025-1">2025-1</option>
              <option value="2025-2">2025-2</option>
              <option value="2024-2">2024-2</option>
            </select>
          </div>
        </div>
        <div class="form-buttons">
          <button type="button" class="btn-cancel" onclick="closeModal('asignacionModal')">Cancelar</button>
          <button type="submit" class="btn-save">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Inscripci√≥n -->
  <div id="inscripcionModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('inscripcionModal')">&times;</span>
      <h3>Nueva Inscripci√≥n</h3>
      <form id="inscripcionForm">
        <div class="form-row">
          <div class="form-group">
            <label for="inscripcionAlumno">Alumno:</label>
            <select id="inscripcionAlumno" required>
              <option value="">Seleccionar alumno</option>
            </select>
          </div>
          <div class="form-group">
            <label for="inscripcionMateria">Materia:</label>
            <select id="inscripcionMateria" required>
              <option value="">Seleccionar materia</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="inscripcionGrupo">Grupo:</label>
            <select id="inscripcionGrupo" required>
              <option value="">Seleccione una materia primero</option>
            </select>
          </div>
          <div class="form-group">
            <label for="inscripcionPeriodo">Periodo:</label>
            <select id="inscripcionPeriodo" required>
              <option value="2025-1">2025-1</option>
              <option value="2025-2">2025-2</option>
              <option value="2024-2">2024-2</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="inscripcionEstado">Estado:</label>
          <select id="inscripcionEstado" required>
            <option value="activa">Activa</option>
            <option value="inactiva">Inactiva</option>
            <option value="completada">Completada</option>
          </select>
        </div>
        <div class="form-buttons">
          <button type="button" class="btn-cancel" onclick="closeModal('inscripcionModal')">Cancelar</button>
          <button type="submit" class="btn-save">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Inscripci√≥n Masiva -->
  <div id="masiveInscripcionModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('masiveInscripcionModal')">&times;</span>
      <h3>Inscripci√≥n Masiva</h3>
      <form id="masiveInscripcionForm">
        <div class="form-row">
          <div class="form-group">
            <label for="masiveMateria">Materia:</label>
            <select id="masiveMateria" required>
              <option value="">Seleccionar materia</option>
            </select>
          </div>
          <div class="form-group">
            <label for="masiveGrupo">Grupo:</label>
            <input type="text" id="masiveGrupo" placeholder="A1, B2, etc." required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="masivePeriodo">Periodo:</label>
            <select id="masivePeriodo" required>
              <option value="2025-1">2025-1</option>
              <option value="2025-2">2025-2</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Seleccionar Alumnos:</label>
          <div id="alumnosCheckboxList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
            <div class="loading">Cargando alumnos...</div>
          </div>
        </div>
        <div class="form-buttons">
          <button type="button" class="btn-cancel" onclick="closeModal('masiveInscripcionModal')">Cancelar</button>
          <button type="submit" class="btn-save">Inscribir Seleccionados</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Notificaci√≥n -->
  <div id="notification" class="notification"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { auth, db, firebaseConfig } from './js/firebase-config.js';
    import { 
      createUserWithEmailAndPassword, 
      signOut,
      onAuthStateChanged,
      getAuth
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { 
      collection, 
      addDoc, 
      getDocs, 
      doc, 
      setDoc, 
      deleteDoc, 
      updateDoc,
      query,
      where,
      orderBy,
      getDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // Crear una instancia secundaria de Firebase para el registro de usuarios
    const secondaryApp = initializeApp(firebaseConfig, "secondary");
    const secondaryAuth = getAuth(secondaryApp);

    let currentUser = null;
    let currentUserRole = null;
    let currentUserId = null;
    let currentMateriaId = null;
    let currentAsignacionId = null;
    let currentInscripcionId = null;
    let allUsers = [];
    let allMaterias = [];
    let allAsignaciones = [];
    let allInscripciones = [];

    // Definir permisos por rol
    const rolePermissions = {
      POWERUSER: {
        canCreateRoles: ['POWERUSER', 'ADMIN', 'DOCENTE', 'ALUMNO'],
        canDeleteAnyUser: true,
        canEditAnyUser: true,
        hasFullAccess: true
      },
      ADMIN: {
        canCreateRoles: ['DOCENTE', 'ALUMNO'],
        canDeleteAnyUser: false, // Solo pueden eliminar usuarios que crearon
        canEditAnyUser: false,
        hasFullAccess: false
      },
      DOCENTE: {
        canCreateRoles: ['ALUMNO'],
        canDeleteAnyUser: false,
        canEditAnyUser: false,
        hasFullAccess: false
      }
    };

    // Verificar autenticaci√≥n
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      
      currentUser = user;
      await loadCurrentUserInfo();
      if (!checkAccess()) {
        window.location.href = 'login.html';
        return;
      }
      setupInterface();
    });

    // Cargar informaci√≥n del usuario actual
    async function loadCurrentUserInfo() {
      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          currentUserRole = userData.role;
          document.getElementById('userName').textContent = userData.nombre;
          updateRoleBadge(currentUserRole);
          showPermissionNotice();
        }
      } catch (error) {
        console.error('Error cargando informaci√≥n del usuario:', error);
      }
    }

    // Verificar acceso
    function checkAccess() {
      return ['POWERUSER', 'ADMIN'].includes(currentUserRole);
    }

    // Actualizar badge de rol
    function updateRoleBadge(role) {
      const badge = document.getElementById('userRoleBadge');
      badge.textContent = role;
      badge.className = `role-badge ${role.toLowerCase()}`;
    }

    // Mostrar aviso de permisos
    function showPermissionNotice() {
      const notice = document.getElementById('permissionNotice');
      const text = document.getElementById('permissionText');
      
      if (currentUserRole === 'ADMIN') {
        notice.style.display = 'block';
        text.textContent = 'Como ADMIN, solo puedes crear usuarios DOCENTE y ALUMNO.';
      } else if (currentUserRole === 'POWERUSER') {
        notice.style.display = 'block';
        notice.style.background = '#e8f5e8';
        notice.style.borderColor = '#28a745';
        notice.style.color = '#155724';
        text.textContent = 'Como POWERUSER, tienes acceso completo a todas las funcionalidades.';
      }
    }

    // Configurar interfaz seg√∫n permisos
    async function setupInterface() {
      const permissions = rolePermissions[currentUserRole];
      
      // Configurar opciones de rol en el modal
      setupRoleOptions();
      
      // Cargar datos iniciales
      await loadUsers();
      await loadMaterias();
    }

    // Configurar opciones de rol disponibles
    function setupRoleOptions() {
      const roleSelect = document.getElementById('userRole');
      const permissions = rolePermissions[currentUserRole];
      
      let options = '<option value="">Seleccionar rol</option>';
      permissions.canCreateRoles.forEach(role => {
        const roleNames = {
          'POWERUSER': 'Power User',
          'ADMIN': 'Administrador',
          'DOCENTE': 'Docente',
          'ALUMNO': 'Alumno'
        };
        options += `<option value="${role}">${roleNames[role]}</option>`;
      });
      
      roleSelect.innerHTML = options;
    }

    // Funciones de navegaci√≥n
    window.showTab = function(tabName) {
      // Ocultar todas las secciones
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Mostrar secci√≥n seleccionada
      document.getElementById(tabName).classList.add('active');
      
      // Actualizar tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Cargar datos seg√∫n la pesta√±a
      switch(tabName) {
        case 'usuarios':
          loadUsers();
          break;
        case 'materias':
          loadMaterias();
          break;
        case 'asignaciones':
          loadAsignaciones();
          break;
        case 'inscripciones':
          loadInscripciones();
          break;
      }
    };

    window.logout = async function() {
      try {
        await signOut(auth);
        window.location.href = 'login.html';
      } catch (error) {
        console.error('Error al cerrar sesi√≥n:', error);
      }
    };

    // Funciones de modal
    window.openUserModal = function(userId = null) {
      currentUserId = userId;
      const modal = document.getElementById('userModal');
      const title = document.getElementById('userModalTitle');
      
      if (userId) {
        title.textContent = 'Editar Usuario';
        const user = allUsers.find(u => u.id === userId);
        if (user) {
          // Verificar permisos de edici√≥n
          if (!canEditUser(user)) {
            showNotification('No tienes permisos para editar este usuario', 'error');
            return;
          }
          
          document.getElementById('userNameInput').value = user.nombre;
          document.getElementById('userEmail').value = user.email;
          document.getElementById('userRole').value = user.role || 'ALUMNO';
          document.getElementById('userControl').value = user.numeroControl;
          document.getElementById('userStatus').value = user.status || 'active';
          document.getElementById('userPassword').removeAttribute('required');
        }
      } else {
        title.textContent = 'Agregar Usuario';
        document.getElementById('userForm').reset();
        document.getElementById('userPassword').setAttribute('required', '');
      }
      
      setupRoleOptions(); // Actualizar opciones disponibles
      modal.style.display = 'block';
    };

    // Verificar si puede editar usuario
    function canEditUser(user) {
      const permissions = rolePermissions[currentUserRole];
      
      if (permissions.hasFullAccess) return true;
      
      // ADMIN solo puede editar usuarios que no sean POWERUSER o ADMIN
      if (currentUserRole === 'ADMIN') {
        return !['POWERUSER', 'ADMIN'].includes(user.role);
      }
      
      return false;
    }

    // Verificar si puede eliminar usuario
    function canDeleteUser(user) {
      const permissions = rolePermissions[currentUserRole];
      
      if (permissions.hasFullAccess) return true;
      
      // ADMIN solo puede eliminar DOCENTE y ALUMNO
      if (currentUserRole === 'ADMIN') {
        return ['DOCENTE', 'ALUMNO'].includes(user.role);
      }
      
      return false;
    }

    window.openMateriaModal = function(materiaId = null) {
      currentMateriaId = materiaId;
      const modal = document.getElementById('materiaModal');
      const title = document.getElementById('materiaModalTitle');
      
      if (materiaId) {
        title.textContent = 'Editar Materia';
        const materia = allMaterias.find(m => m.id === materiaId);
        if (materia) {
          document.getElementById('materiaCodigo').value = materia.codigo;
          document.getElementById('materiaNombre').value = materia.nombre;
          document.getElementById('materiaCreditos').value = materia.creditos || '';
          document.getElementById('materiaSemestre').value = materia.semestre || '';
          document.getElementById('materiaUnidades').value = Array.isArray(materia.unidades) ? materia.unidades.join(', ') : materia.unidades;
          document.getElementById('materiaGrupos').value = Array.isArray(materia.grupos) ? materia.grupos.join(', ') : materia.grupos || '';
        }
      } else {
        title.textContent = 'Agregar Materia';
        document.getElementById('materiaForm').reset();
      }
      
      modal.style.display = 'block';
    };

    window.openAsignacionModal = async function(asignacionId = null) {
      currentAsignacionId = asignacionId;
      const modal = document.getElementById('asignacionModal');
      const title = document.querySelector('#asignacionModal h3');
      
      document.getElementById('asignacionForm').reset();
      
      await loadDocentesSelect();
      await loadMateriasSelect();
      
      if (asignacionId) {
        title.textContent = 'Editar Asignaci√≥n';
        const asignacion = allAsignaciones.find(a => a.id === asignacionId);
        if (asignacion) {
          document.getElementById('asignacionDocente').value = asignacion.docenteId;
          document.getElementById('asignacionMateria').value = asignacion.materiaId;
          document.getElementById('asignacionPeriodo').value = asignacion.periodo;
          
          // Cargar grupos de la materia y seleccionar el grupo de la asignaci√≥n
          loadGruposSelect(asignacion.materiaId);
          setTimeout(() => {
            document.getElementById('asignacionGrupo').value = asignacion.grupo;
          }, 100);
        }
      } else {
        title.textContent = 'Nueva Asignaci√≥n';
      }
      
      modal.style.display = 'block';
    };

    window.openInscripcionModal = async function() {
      const modal = document.getElementById('inscripcionModal');
      document.getElementById('inscripcionForm').reset();
      
      await loadAlumnosSelect();
      await loadMateriasSelectInscripcion();
      
      modal.style.display = 'block';
    };

    window.openMasiveInscripcionModal = async function() {
      const modal = document.getElementById('masiveInscripcionModal');
      document.getElementById('masiveInscripcionForm').reset();
      
      await loadMateriasSelectMasive();
      await loadAlumnosCheckboxList();
      
      modal.style.display = 'block';
    };

    window.closeModal = function(modalId) {
      document.getElementById(modalId).style.display = 'none';
    };

    // Cargar datos
    async function loadUsers() {
      const tableBody = document.getElementById('usersTable');
      try {
        const querySnapshot = await getDocs(collection(db, 'users'));
        allUsers = [];
        let html = '';
        
        let totalUsuarios = 0, totalDocentes = 0, totalAlumnos = 0, totalAdmins = 0, totalPowerUsers = 0;
        
        querySnapshot.forEach((doc) => {
          const user = { id: doc.id, ...doc.data() };
          allUsers.push(user);
          
          totalUsuarios++;
          const userRole = user.role || 'ALUMNO';
          switch(userRole) {
            case 'DOCENTE': totalDocentes++; break;
            case 'ALUMNO': totalAlumnos++; break;
            case 'ADMIN': totalAdmins++; break;
            case 'POWERUSER': totalPowerUsers++; break;
          }
          
          const statusClass = user.status === 'active' ? 'status-active' : 'status-inactive';
          const statusText = user.status === 'active' ? 'Activo' : 'Inactivo';
          
          // Validar que el rol existe antes de procesarlo
          const roleClass = `role-${userRole.toLowerCase()}`;
          const roleText = {
            'POWERUSER': 'Power User',
            'ADMIN': 'Admin',
            'DOCENTE': 'Docente',
            'ALUMNO': 'Alumno'
          }[userRole] || userRole;
          
          // Determinar acciones disponibles
          const canEdit = canEditUser(user);
          const canDelete = canDeleteUser(user);
          
          let actionsHTML = '';
          if (canEdit) {
            actionsHTML += `<button class="edit-btn" onclick="openUserModal('${user.id}')">Editar</button>`;
          }
          if (canDelete) {
            actionsHTML += `<button class="delete-btn" onclick="deleteUser('${user.id}')">Eliminar</button>`;
          }
          
          html += `
            <tr>
              <td>${user.nombre}</td>
              <td>${user.email}</td>
              <td><span class="role-badge-table ${roleClass}">${roleText}</span></td>
              <td>${user.numeroControl}</td>
              <td><span class="status-badge ${statusClass}">${statusText}</span></td>
              <td class="action-buttons">
                ${actionsHTML || '<span style="color: #999;">Sin permisos</span>'}
              </td>
            </tr>
          `;
        });
        
        // Actualizar estad√≠sticas
        document.getElementById('totalUsuarios').textContent = totalUsuarios;
        document.getElementById('totalDocentes').textContent = totalDocentes;
        document.getElementById('totalAlumnos').textContent = totalAlumnos;
        document.getElementById('totalAdmins').textContent = totalAdmins;
        document.getElementById('totalPowerUsers').textContent = totalPowerUsers;
        
        tableBody.innerHTML = html || '<tr><td colspan="6">No hay usuarios registrados</td></tr>';
      } catch (error) {
        console.error('Error cargando usuarios:', error);
        tableBody.innerHTML = '<tr><td colspan="6">Error cargando usuarios</td></tr>';
      }
    }

    async function loadMaterias() {
      const tableBody = document.getElementById('materiasTable');
      try {
        const querySnapshot = await getDocs(collection(db, 'materias'));
        allMaterias = [];
        let html = '';
        let totalMaterias = 0, totalCreditos = 0;
        
        querySnapshot.forEach((doc) => {
          const materia = { id: doc.id, ...doc.data() };
          allMaterias.push(materia);
          
          totalMaterias++;
          totalCreditos += materia.creditos || 0;
          
          const unidades = Array.isArray(materia.unidades) ? materia.unidades.join(', ') : materia.unidades;
          const grupos = Array.isArray(materia.grupos) ? materia.grupos.join(', ') : materia.grupos || 'N/A';
          html += `
            <tr>
              <td>${materia.codigo}</td>
              <td>${materia.nombre}</td>
              <td>${materia.creditos || 'N/A'}</td>
              <td>${materia.unidades ? materia.unidades.length : 0}</td>
              <td>${grupos}</td>
              <td>${materia.semestre || 'N/A'}</td>
              <td class="action-buttons">
                <button class="edit-btn" onclick="openMateriaModal('${materia.id}')">Editar</button>
                <button class="delete-btn" onclick="deleteMateria('${materia.id}')">Eliminar</button>
              </td>
            </tr>
          `;
        });
        
        document.getElementById('totalMaterias').textContent = totalMaterias;
        document.getElementById('totalCreditos').textContent = totalCreditos;
        
        tableBody.innerHTML = html || '<tr><td colspan="7">No hay materias registradas</td></tr>';
      } catch (error) {
        console.error('Error cargando materias:', error);
        tableBody.innerHTML = '<tr><td colspan="7">Error cargando materias</td></tr>';
      }
    }

    async function loadAsignaciones() {
      const tableBody = document.getElementById('asignacionesTable');
      try {
        const querySnapshot = await getDocs(collection(db, 'asignaciones'));
        allAsignaciones = [];
        let html = '';
        
        for (const docSnap of querySnapshot.docs) {
          const asignacion = { id: docSnap.id, ...docSnap.data() };
          allAsignaciones.push(asignacion);
          
          // Obtener nombres de docente y materia
          const docente = allUsers.find(u => u.id === asignacion.docenteId);
          const materia = allMaterias.find(m => m.id === asignacion.materiaId);
          
          const docenteNombre = docente?.nombre || 'Docente no encontrado';
          const materiaNombre = materia?.nombre || 'Materia no encontrada';
          
          const fechaCreacion = asignacion.createdAt ? new Date(asignacion.createdAt).toLocaleDateString() : 'N/A';
          
          html += `
            <tr>
              <td>${docenteNombre}</td>
              <td>${materiaNombre}</td>
              <td>${asignacion.grupo}</td>
              <td>${asignacion.periodo || 'N/A'}</td>
              <td>${fechaCreacion}</td>
              <td class="action-buttons">
                <button class="edit-btn" onclick="openAsignacionModal('${asignacion.id}')">Editar</button>
                <button class="delete-btn" onclick="deleteAsignacion('${asignacion.id}')">Eliminar</button>
              </td>
            </tr>
          `;
        }
        
        document.getElementById('totalAsignaciones').textContent = allAsignaciones.length;
        tableBody.innerHTML = html || '<tr><td colspan="6">No hay asignaciones registradas</td></tr>';
      } catch (error) {
        console.error('Error cargando asignaciones:', error);
        tableBody.innerHTML = '<tr><td colspan="6">Error cargando asignaciones</td></tr>';
      }
    }

    async function loadInscripciones() {
      const tableBody = document.getElementById('inscripcionesTable');
      try {
        const querySnapshot = await getDocs(collection(db, 'inscripciones'));
        allInscripciones = [];
        let html = '';
        let inscripcionesActivas = 0;
        
        // Cargar filtros
        const grupos = new Set();
        
        for (const docSnap of querySnapshot.docs) {
          const inscripcion = { id: docSnap.id, ...docSnap.data() };
          allInscripciones.push(inscripcion);
          
          if (inscripcion.status === 'activa') inscripcionesActivas++;
          grupos.add(inscripcion.grupo);
          
          // Obtener nombres de alumno y materia
          const alumno = allUsers.find(u => u.id === inscripcion.alumnoId);
          const materia = allMaterias.find(m => m.id === inscripcion.materiaId);
          
          const alumnoNombre = alumno?.nombre || 'Alumno no encontrado';
          const alumnoControl = alumno?.numeroControl || 'N/A';
          const materiaNombre = materia?.nombre || 'Materia no encontrada';
          
          const fechaCreacion = inscripcion.createdAt ? new Date(inscripcion.createdAt).toLocaleDateString() : 'N/A';
          
          const statusClass = inscripcion.status === 'activa' ? 'status-active' : 'status-inactive';
          
          html += `
            <tr>
              <td>${alumnoNombre}</td>
              <td>${alumnoControl}</td>
              <td>${materiaNombre}</td>
              <td>${inscripcion.grupo}</td>
              <td>${inscripcion.periodo || 'N/A'}</td>
              <td><span class="status-badge ${statusClass}">${inscripcion.status || 'activa'}</span></td>
              <td>${fechaCreacion}</td>
              <td class="action-buttons">
                <button class="edit-btn" onclick="editInscripcion('${inscripcion.id}')">Editar</button>
                <button class="delete-btn" onclick="deleteInscripcion('${inscripcion.id}')">Eliminar</button>
              </td>
            </tr>
          `;
        }
        
        // Actualizar estad√≠sticas
        document.getElementById('totalInscripciones').textContent = allInscripciones.length;
        document.getElementById('inscripcionesActivas').textContent = inscripcionesActivas;
        
        // Actualizar filtros
        updateGruposFilter([...grupos]);
        updateMateriasFilter();
        
        tableBody.innerHTML = html || '<tr><td colspan="8">No hay inscripciones registradas</td></tr>';
      } catch (error) {
        console.error('Error cargando inscripciones:', error);
        tableBody.innerHTML = '<tr><td colspan="8">Error cargando inscripciones</td></tr>';
      }
    }

    // Cargar selects
    async function loadDocentesSelect() {
      const select = document.getElementById('asignacionDocente');
      let html = '<option value="">Seleccionar docente</option>';
      
      allUsers.filter(u => u.role === 'DOCENTE').forEach(docente => {
        html += `<option value="${docente.id}">${docente.nombre}</option>`;
      });
      
      select.innerHTML = html;
    }

    async function loadMateriasSelect() {
      const select = document.getElementById('asignacionMateria');
      let html = '<option value="">Seleccionar materia</option>';
      
      allMaterias.forEach(materia => {
        html += `<option value="${materia.id}">${materia.nombre}</option>`;
      });
      
      select.innerHTML = html;
      
      // Agregar event listener para cargar grupos cuando se seleccione materia
      select.addEventListener('change', function() {
        loadGruposSelect(this.value);
      });
    }

    function loadGruposSelect(materiaId) {
      const grupoSelect = document.getElementById('asignacionGrupo');
      grupoSelect.innerHTML = '<option value="">Seleccionar grupo</option>';
      
      if (!materiaId) return;
      
      const materia = allMaterias.find(m => m.id === materiaId);
      if (materia && materia.grupos) {
        materia.grupos.forEach(grupo => {
          grupoSelect.innerHTML += `<option value="${grupo}">${grupo}</option>`;
        });
      }
    }

    async function loadAlumnosSelect() {
      const select = document.getElementById('inscripcionAlumno');
      let html = '<option value="">Seleccionar alumno</option>';
      
      allUsers.filter(u => u.role === 'ALUMNO').forEach(alumno => {
        html += `<option value="${alumno.id}">${alumno.nombre} (${alumno.numeroControl})</option>`;
      });
      
      select.innerHTML = html;
    }

    async function loadMateriasSelectInscripcion() {
      const select = document.getElementById('inscripcionMateria');
      let html = '<option value="">Seleccionar materia</option>';
      
      allMaterias.forEach(materia => {
        html += `<option value="${materia.id}">${materia.nombre}</option>`;
      });
      
      select.innerHTML = html;

      // Agregar event listener para cargar grupos cuando se seleccione materia
      select.addEventListener('change', function() {
        loadGruposParaInscripcion(this.value);
      });
    }

    function loadGruposParaInscripcion(materiaId) {
      const grupoSelect = document.getElementById('inscripcionGrupo');
      grupoSelect.innerHTML = '<option value="">Seleccionar grupo</option>';
      
      if (!materiaId) return;
      
      const materia = allMaterias.find(m => m.id === materiaId);
      if (materia && materia.grupos) {
        materia.grupos.forEach(grupo => {
          grupoSelect.innerHTML += `<option value="${grupo}">${grupo}</option>`;
        });
      } else {
        grupoSelect.innerHTML = '<option value="">No hay grupos definidos</option>';
      }
    }

    async function loadMateriasSelectMasive() {
      const select = document.getElementById('masiveMateria');
      let html = '<option value="">Seleccionar materia</option>';
      
      allMaterias.forEach(materia => {
        html += `<option value="${materia.id}">${materia.nombre}</option>`;
      });
      
      select.innerHTML = html;
    }

    async function loadAlumnosCheckboxList() {
      const container = document.getElementById('alumnosCheckboxList');
      let html = '';
      
      const alumnos = allUsers.filter(u => u.role === 'ALUMNO');
      
      if (alumnos.length === 0) {
        html = '<p>No hay alumnos disponibles</p>';
      } else {
        alumnos.forEach(alumno => {
          html += `
            <div style="margin-bottom: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" value="${alumno.id}" name="selectedAlumnos">
                <span>${alumno.nombre} (${alumno.numeroControl})</span>
              </label>
            </div>
          `;
        });
      }
      
      container.innerHTML = html;
    }

    function updateGruposFilter(grupos) {
      const select = document.getElementById('filterGrupo');
      let html = '<option value="">Todos los grupos</option>';
      
      grupos.forEach(grupo => {
        html += `<option value="${grupo}">${grupo}</option>`;
      });
      
      select.innerHTML = html;
    }

    function updateMateriasFilter() {
      const select = document.getElementById('filterMateria');
      let html = '<option value="">Todas las materias</option>';
      
      allMaterias.forEach(materia => {
        html += `<option value="${materia.id}">${materia.nombre}</option>`;
      });
      
      select.innerHTML = html;
    }

    // Event listeners para formularios
    document.getElementById('userForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const selectedRole = document.getElementById('userRole').value;
      
      // Verificar permisos para crear el rol seleccionado
      const permissions = rolePermissions[currentUserRole];
      if (!permissions.canCreateRoles.includes(selectedRole)) {
        showNotification('No tienes permisos para crear usuarios con este rol', 'error');
        return;
      }
      
      const userData = {
        nombre: document.getElementById('userNameInput').value,
        email: document.getElementById('userEmail').value,
        role: selectedRole,
        numeroControl: document.getElementById('userControl').value,
        status: document.getElementById('userStatus').value
      };
      
      try {
        if (currentUserId) {
          // Actualizar usuario existente
          await updateDoc(doc(db, 'users', currentUserId), userData);
          showNotification('Usuario actualizado exitosamente', 'success');
        } else {
          // Crear nuevo usuario
          const password = document.getElementById('userPassword').value;
          const userCredential = await createUserWithEmailAndPassword(secondaryAuth, userData.email, password);
          await setDoc(doc(db, 'users', userCredential.user.uid), userData);
          showNotification('Usuario creado exitosamente', 'success');
        }
        
        closeModal('userModal');
        loadUsers();
      } catch (error) {
        console.error('Error guardando usuario:', error);
        showNotification('Error al guardar usuario: ' + error.message, 'error');
      }
    });

    document.getElementById('materiaForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const unidadesText = document.getElementById('materiaUnidades').value;
      const unidadesArray = unidadesText.split(',').map(u => u.trim());
      
      const gruposText = document.getElementById('materiaGrupos').value;
      const gruposArray = gruposText.split(',').map(g => g.trim());
      
      const materiaData = {
        codigo: document.getElementById('materiaCodigo').value,
        nombre: document.getElementById('materiaNombre').value,
        creditos: parseInt(document.getElementById('materiaCreditos').value),
        semestre: parseInt(document.getElementById('materiaSemestre').value) || null,
        unidades: unidadesArray,
        grupos: gruposArray,
        createdAt: new Date().toISOString()
      };
      
      try {
        if (currentMateriaId) {
          await updateDoc(doc(db, 'materias', currentMateriaId), materiaData);
          showNotification('Materia actualizada exitosamente', 'success');
        } else {
          await addDoc(collection(db, 'materias'), materiaData);
          showNotification('Materia creada exitosamente', 'success');
        }
        
        closeModal('materiaModal');
        loadMaterias();
      } catch (error) {
        console.error('Error guardando materia:', error);
        showNotification('Error al guardar materia: ' + error.message, 'error');
      }
    });

    document.getElementById('asignacionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const asignacionData = {
        docenteId: document.getElementById('asignacionDocente').value,
        materiaId: document.getElementById('asignacionMateria').value,
        grupo: document.getElementById('asignacionGrupo').value,
        periodo: document.getElementById('asignacionPeriodo').value
      };
      
      try {
        if (currentAsignacionId) {
          // Actualizar asignaci√≥n existente
          await updateDoc(doc(db, 'asignaciones', currentAsignacionId), asignacionData);
          showNotification('Asignaci√≥n actualizada exitosamente', 'success');
        } else {
          // Crear nueva asignaci√≥n
          asignacionData.createdAt = new Date().toISOString();
          await addDoc(collection(db, 'asignaciones'), asignacionData);
          showNotification('Asignaci√≥n creada exitosamente', 'success');
        }
        
        closeModal('asignacionModal');
        loadAsignaciones();
      } catch (error) {
        console.error('Error guardando asignaci√≥n:', error);
        showNotification('Error al guardar asignaci√≥n: ' + error.message, 'error');
      }
    });

    document.getElementById('inscripcionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const inscripcionData = {
        alumnoId: document.getElementById('inscripcionAlumno').value,
        materiaId: document.getElementById('inscripcionMateria').value,
        grupo: document.getElementById('inscripcionGrupo').value,
        periodo: document.getElementById('inscripcionPeriodo').value,
        status: document.getElementById('inscripcionEstado').value,
        createdAt: new Date().toISOString()
      };
      
      try {
        await addDoc(collection(db, 'inscripciones'), inscripcionData);
        closeModal('inscripcionModal');
        loadInscripciones();
        showNotification('Inscripci√≥n creada exitosamente', 'success');
      } catch (error) {
        console.error('Error creando inscripci√≥n:', error);
        showNotification('Error al crear inscripci√≥n: ' + error.message, 'error');
      }
    });

    document.getElementById('masiveInscripcionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const materiaId = document.getElementById('masiveMateria').value;
      const grupo = document.getElementById('masiveGrupo').value;
      const periodo = document.getElementById('masivePeriodo').value;
      
      const selectedAlumnos = Array.from(document.querySelectorAll('input[name="selectedAlumnos"]:checked'))
        .map(checkbox => checkbox.value);
      
      if (selectedAlumnos.length === 0) {
        showNotification('Selecciona al menos un alumno', 'warning');
        return;
      }
      
      try {
        let successCount = 0;
        
        for (const alumnoId of selectedAlumnos) {
          const inscripcionData = {
            alumnoId: alumnoId,
            materiaId: materiaId,
            grupo: grupo,
            periodo: periodo,
            status: 'activa',
            createdAt: new Date().toISOString()
          };
          
          await addDoc(collection(db, 'inscripciones'), inscripcionData);
          successCount++;
        }
        
        closeModal('masiveInscripcionModal');
        loadInscripciones();
        showNotification(`${successCount} inscripciones creadas exitosamente`, 'success');
      } catch (error) {
        console.error('Error en inscripci√≥n masiva:', error);
        showNotification('Error en inscripci√≥n masiva: ' + error.message, 'error');
      }
    });

    // Funciones de eliminaci√≥n
    window.deleteUser = async function(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user || !canDeleteUser(user)) {
        showNotification('No tienes permisos para eliminar este usuario', 'error');
        return;
      }
      
      if (confirm('¬øEst√° seguro de eliminar este usuario?')) {
        try {
          await deleteDoc(doc(db, 'users', userId));
          loadUsers();
          showNotification('Usuario eliminado exitosamente', 'success');
        } catch (error) {
          console.error('Error eliminando usuario:', error);
          showNotification('Error al eliminar usuario', 'error');
        }
      }
    };

    window.deleteMateria = async function(materiaId) {
      if (confirm('¬øEst√° seguro de eliminar esta materia?')) {
        try {
          await deleteDoc(doc(db, 'materias', materiaId));
          loadMaterias();
          showNotification('Materia eliminada exitosamente', 'success');
        } catch (error) {
          console.error('Error eliminando materia:', error);
          showNotification('Error al eliminar materia', 'error');
        }
      }
    };

    window.deleteAsignacion = async function(asignacionId) {
      if (confirm('¬øEst√° seguro de eliminar esta asignaci√≥n?')) {
        try {
          await deleteDoc(doc(db, 'asignaciones', asignacionId));
          loadAsignaciones();
          showNotification('Asignaci√≥n eliminada exitosamente', 'success');
        } catch (error) {
          console.error('Error eliminando asignaci√≥n:', error);
          showNotification('Error al eliminar asignaci√≥n', 'error');
        }
      }
    };

    window.deleteInscripcion = async function(inscripcionId) {
      if (confirm('¬øEst√° seguro de eliminar esta inscripci√≥n?')) {
        try {
          await deleteDoc(doc(db, 'inscripciones', inscripcionId));
          loadInscripciones();
          showNotification('Inscripci√≥n eliminada exitosamente', 'success');
        } catch (error) {
          console.error('Error eliminando inscripci√≥n:', error);
          showNotification('Error al eliminar inscripci√≥n', 'error');
        }
      }
    };

    // Funci√≥n para mostrar notificaciones
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>